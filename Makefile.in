#
# $Id$
#
# THIS MAKEFILE *REQUIRES* GNU MAKE!
# ----------------------------------

include .version

# Set levels of DEBUG.
#DEBUGS	= -DDEBUG
#DEBUG_WFLAGS = -pedantic -Wmissing-prototypes

# OS-specific defines.
DEFINES_linux-gnu	= -DSUPPORT_TCPDUMP

# General definitions.
DEFINES	= $(DEFINES_@this_os@) -DIS_VERSION="$(IS_VERSION)"

# The Ted Ts'o express.  Noisy under some OS's.  Very gcc-specific.
WFLAGS	= -Wall -Wcast-align -Wcast-qual -Winline \
          -Wpointer-arith -Wshadow -Wwrite-strings

# OS-specific C compiler flags.
CFLAGS_linux-gnu	= -fomit-frame-pointer -fno-strength-reduce

# Autoconf-determined compiler definitions.
CC	= @CXX@
CFLAGS	= @CFLAGS@ $(CFLAGS_@this_os@) $(DEBUGS) $(DEFINES) $(DEBUG_WFLAGS) $(WFLAGS)
CXXFLAGS = $(CFLAGS)

# OS-specific feature support.
SRCS_linux-gnu	= pcap-tcpdump.c

PROG	= issniff
MANEXT	= 8
CSRCS	= @this_os@.c filter.c if.c lists.c shm.c $(SRCS_@this_os@)
CXXSRCS = sniff.cpp
MANSRC	= $(PROG).man
OBJS	= $(CSRCS:.c=.o) $(CXXSRCS:.cpp=.o)
MANUAL	= $(MANSRC:.man=.$(MANEXT))

# Target rules start here: no user-servicable parts beyond this point.
.PHONY:	all do-all clean distclean maintainer-clean maintainer-world

all:	do-all

# Bootstrap the dependencies (reminiscent of old Linux kernel Makefiles).
ifeq (.depend, $(wildcard .depend))
include .depend
do-all:	$(PROG) $(MANUAL)
else
do-all:	.depend
	$(MAKE)
endif

.depend:
	@CPP@ -M $(DEBUGS) $(DEFINES) $(SRCS) > $@

$(PROG):	$(OBJS)
	$(CC) @LDFLAGS@ -o $@ $^ @LIBS@

$(MANUAL):	$(MANSRC) .version
	$(RM) $@
	sed 's/@@IS_VERSION@@/$(IS_VERSION)/g' $< > $@

clean:
	$(RM) $(PROG) $(MANUAL) *.o

dist:	distclean
	tar -cjvf $(PROG)-$(IS_VERSION).tar.bz2 -C .. $(PROG) --exclude $(PROG)/.git --exclude $(PROG)/$(PROG)-$(IS_VERSION).tar.bz2 --exclude $(PROG)/.*ignore

distclean:	clean
	$(RM) .depend Makefile config.cache config.h config.log config.status core* *~ \#*
	$(RM) -r autom4te.cache

# The following are development targets and are not meant for general use.
maintainer-clean:	distclean
	$(RM) configure

maintainer-world:	maintainer-clean
	autoconf -Wall
	./configure
	$(MAKE)
